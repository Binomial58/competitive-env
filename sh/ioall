#!/bin/bash

SAMPLE_DIR="samples"
FAIL_DIR="failures"

CLEAN=false
if [ "$1" = "--clean" ]; then
    CLEAN=true
fi

if $CLEAN; then
    rm -rf "$FAIL_DIR"
fi

if [ ! -f "./a.out" ]; then
    echo "error: a.out not found."
    exit 1
fi

if [ ! -d "$SAMPLE_DIR" ]; then
    echo "error: samples directory not found."
    exit 1
fi

shopt -s nullglob
OK_ALL=true

for infile in "$SAMPLE_DIR"/*.in; do
    base="$(basename "${infile%.in}")"
    outfile="$SAMPLE_DIR/$base.out"
    tmpfile="$SAMPLE_DIR/$base.tmp"
    difffile="$FAIL_DIR/$base.diff"

    start=$(date +%s%3N)
    ./a.out < "$infile" > "$tmpfile"
    end=$(date +%s%3N)

    elapsed=$((end - start))

    if diff -u "$outfile" "$tmpfile" > /dev/null; then
        echo "[OK]   $base (${elapsed} ms)"
    else
        echo "[NG]   $base (${elapsed} ms)"
        mkdir -p "$FAIL_DIR"
        diff -u "$outfile" "$tmpfile" | tee "$difffile"
        OK_ALL=false
    fi

    rm "$tmpfile"
done

if $OK_ALL; then
    echo "=== 全サンプルOK ==="
else
    echo "=== 一部NG ==="
fi
